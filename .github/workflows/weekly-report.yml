name: Weekly Sales Report Generation

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (UTC+9) = ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 12ì‹œ (UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-nanum fonts-nanum-coding fonts-nanum-extra
        # í•œê¸€ í°íŠ¸ ì„¤ì¹˜ (Malgun Gothic ëŒ€ì²´)
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas matplotlib seaborn numpy openpyxl python-docx
    
    - name: Set up Korean timezone
      run: |
        sudo timedatectl set-timezone Asia/Seoul
    
    - name: Configure matplotlib for headless environment
      run: |
        python -c "
        import matplotlib
        matplotlib.use('Agg')
        import matplotlib.pyplot as plt
        plt.rcParams['font.family'] = 'DejaVu Sans'  # Ubuntuì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ í°íŠ¸
        print('Matplotlib configured successfully')
        "
    
    - name: Check if data file exists
      run: |
        if [ ! -f "cicd_data.csv" ]; then
          echo "âŒ cicd_data.csv íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          echo "ë°ì´í„° íŒŒì¼ì„ ë¦¬í¬ì§€í† ë¦¬ì— ì¶”ê°€í•´ì£¼ì„¸ìš”."
          exit 1
        else
          echo "âœ… ë°ì´í„° íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤."
          head -5 cicd_data.csv
        fi
    
    - name: Modify script for GitHub Actions environment
      run: |
        # í•œê¸€ í°íŠ¸ ì„¤ì •ì„ Ubuntu í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •
        sed -i "s/plt.rcParams\['font.family'\] = 'Malgun Gothic'/plt.rcParams['font.family'] = 'DejaVu Sans'/" word_report_generator.py
        
        # ì´ë©”ì¼ ì „ì†¡ ë¶€ë¶„ì„ ë¹„í™œì„±í™” (ë³´ì•ˆìƒ ì´ìœ )
        sed -i 's/send_email_interactive()/print("ğŸ“§ GitHub Actions í™˜ê²½ì—ì„œëŠ” ì´ë©”ì¼ ì „ì†¡ì„ ê±´ë„ˆëœë‹ˆë‹¤.")/' word_report_generator.py
    
    - name: Generate sales report
      run: |
        echo "ğŸš€ íŒë§¤ ë³´ê³ ì„œ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
        python word_report_generator.py
    
    - name: List generated files
      run: |
        echo "ğŸ“ ìƒì„±ëœ íŒŒì¼ ëª©ë¡:"
        ls -la *.docx *.png 2>/dev/null || echo "ìƒì„±ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
    
    - name: Upload report as artifact
      uses: actions/upload-artifact@v3
      with:
        name: weekly-sales-report-${{ github.run_number }}
        path: |
          *.docx
          *.png
        retention-days: 30
    
    - name: Create release with report
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: report-${{ github.run_number }}-${{ github.run_id }}
        name: Weekly Sales Report - ${{ github.run_number }}
        body: |
          ğŸ“Š ìë™ ìƒì„±ëœ ì£¼ê°„ íŒë§¤ ë³´ê³ ì„œ
          
          ğŸ•’ ìƒì„± ì‹œê°„: ${{ github.event.repository.updated_at }}
          ğŸ”„ ì‹¤í–‰ ë²ˆí˜¸: ${{ github.run_number }}
          
          ğŸ“ˆ í¬í•¨ëœ ë‚´ìš©:
          - ì›Œë“œ ë³´ê³ ì„œ (sales_analysis_report.docx)
          - ì‹œê°í™” ì°¨íŠ¸ (PNG íŒŒì¼ë“¤)
          
          ğŸ“‹ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ í™•ì¸í•˜ì„¸ìš”.
        files: |
          *.docx
          *.png
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Send notification on failure
      if: failure()
      run: |
        echo "âŒ ë³´ê³ ì„œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
        
    - name: Clean up temporary files
      if: always()
      run: |
        echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
        # ì°¨íŠ¸ íŒŒì¼ë“¤ì€ artifactë¡œ ì—…ë¡œë“œë˜ë¯€ë¡œ ì •ë¦¬í•˜ì§€ ì•ŠìŒ
        echo "ì •ë¦¬ ì™„ë£Œ"