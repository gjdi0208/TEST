name: Weekly Sales Report Generation

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (UTC+9) = ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 12ì‹œ (UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write  # Release ìƒì„±ì„ ìœ„í•œ ê¶Œí•œ
  packages: write
  issues: write

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-nanum fonts-nanum-coding fonts-nanum-extra
        # í•œê¸€ í°íŠ¸ ì„¤ì¹˜ (Malgun Gothic ëŒ€ì²´)
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas matplotlib seaborn numpy openpyxl python-docx
    
    - name: Set up Korean timezone
      run: |
        sudo timedatectl set-timezone Asia/Seoul
    
    - name: Configure matplotlib for headless environment
      run: |
        python -c "
        import matplotlib
        matplotlib.use('Agg')
        import matplotlib.pyplot as plt
        plt.rcParams['font.family'] = 'DejaVu Sans'  # Ubuntuì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ í°íŠ¸
        print('Matplotlib configured successfully')
        "
    
    - name: Check if data file exists
      run: |
        if [ ! -f "cicd_data.csv" ]; then
          echo "âŒ cicd_data.csv íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          echo "ë°ì´í„° íŒŒì¼ì„ ë¦¬í¬ì§€í† ë¦¬ì— ì¶”ê°€í•´ì£¼ì„¸ìš”."
          exit 1
        else
          echo "âœ… ë°ì´í„° íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤."
          head -5 cicd_data.csv
        fi
    
    - name: Generate sales report
      env:
        MPLBACKEND: Agg  # matplotlib headless ë°±ì—”ë“œ ì„¤ì •
      run: |
        echo "ğŸš€ íŒë§¤ ë³´ê³ ì„œ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
        python github_actions_report.py
    
    - name: List generated files
      run: |
        echo "ğŸ“ ìƒì„±ëœ íŒŒì¼ ëª©ë¡:"
        ls -la *.docx *.png 2>/dev/null || echo "ìƒì„±ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
    
    - name: Send email with report
      env:
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL || 'gjdi0208@gmail.com' }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD || 'hkcn ywsk wmxk vqvm' }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL || 'gjdi0208@gmail.com' }}
      run: |
        echo "ğŸ“§ ì´ë©”ì¼ ë°œì†¡ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
        python -c "
        import smtplib
        import os
        from email.mime.multipart import MIMEMultipart
        from email.mime.text import MIMEText
        from email.mime.base import MIMEBase
        from email import encoders
        from datetime import datetime
        import glob
        
        def send_email():
            # ì´ë©”ì¼ ì„¤ì •
            sender_email = os.environ['SENDER_EMAIL']
            sender_password = os.environ['SENDER_PASSWORD']
            recipient_email = os.environ['RECIPIENT_EMAIL']
            
            # ìƒì„±ëœ ë³´ê³ ì„œ íŒŒì¼ ì°¾ê¸°
            docx_files = glob.glob('*.docx')
            if not docx_files:
                print('âŒ ë³´ê³ ì„œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
                return False
            
            report_file = docx_files[0]
            print(f'ğŸ“„ ë³´ê³ ì„œ íŒŒì¼: {report_file}')
            
            # ì´ë©”ì¼ ë©”ì‹œì§€ ìƒì„±
            msg = MIMEMultipart()
            msg['From'] = sender_email
            msg['To'] = recipient_email
            msg['Subject'] = f'ì£¼ê°„ íŒë§¤ ë³´ê³ ì„œ - {datetime.now().strftime(\"%Y-%m-%d\")}'
            
            # ì´ë©”ì¼ ë³¸ë¬¸
            body = '''ì•ˆë…•í•˜ì„¸ìš”!
        
        GitHub Actionsì—ì„œ ìë™ ìƒì„±ëœ ì£¼ê°„ íŒë§¤ ë³´ê³ ì„œë¥¼ ì „ì†¡ë“œë¦½ë‹ˆë‹¤.
        
        ğŸ“Š ë³´ê³ ì„œ ì •ë³´:
        - ìƒì„± ì‹œê°„: ''' + datetime.now().strftime('%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„') + '''
        - íŒŒì¼ëª…: ''' + report_file + '''
        - ìƒì„± ë°©ì‹: GitHub Actions ìë™í™”
        
        ì²¨ë¶€íŒŒì¼ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.
        
        ê°ì‚¬í•©ë‹ˆë‹¤.'''
            
            msg.attach(MIMEText(body, 'plain', 'utf-8'))
            
            # íŒŒì¼ ì²¨ë¶€
            try:
                with open(report_file, 'rb') as attachment:
                    part = MIMEBase('application', 'octet-stream')
                    part.set_payload(attachment.read())
                
                encoders.encode_base64(part)
                part.add_header(
                    'Content-Disposition',
                    f'attachment; filename= {report_file}'
                )
                msg.attach(part)
                
                print(f'âœ… íŒŒì¼ ì²¨ë¶€ ì™„ë£Œ: {report_file}')
            except Exception as e:
                print(f'âŒ íŒŒì¼ ì²¨ë¶€ ì‹¤íŒ¨: {e}')
                return False
            
            # ì´ë©”ì¼ ë°œì†¡
            try:
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(sender_email, sender_password)
                
                text = msg.as_string()
                server.sendmail(sender_email, recipient_email, text)
                server.quit()
                
                print(f'âœ… ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ!')
                print(f'ğŸ“§ ë°œì†¡ì: {sender_email}')
                print(f'ğŸ“¬ ìˆ˜ì‹ ì: {recipient_email}')
                return True
                
            except Exception as e:
                print(f'âŒ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: {e}')
                return False
        
        # ì´ë©”ì¼ ë°œì†¡ ì‹¤í–‰
        success = send_email()
        if not success:
            exit(1)
        "
        
        echo "ğŸ“§ ì´ë©”ì¼ ë°œì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
    
    - name: Upload report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: weekly-sales-report-${{ github.run_number }}
        path: |
          *.docx
          *.png
        retention-days: 30
    
    - name: Create release with report (optional)
      if: success()
      continue-on-error: true  # ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš° ê³„ì† ì§„í–‰
      uses: softprops/action-gh-release@v1
      with:
        tag_name: report-${{ github.run_number }}-${{ github.run_id }}
        name: Weekly Sales Report - ${{ github.run_number }}
        body: |
          ğŸ“Š ìë™ ìƒì„±ëœ ì£¼ê°„ íŒë§¤ ë³´ê³ ì„œ
          
          ğŸ•’ ìƒì„± ì‹œê°„: ${{ github.event.repository.updated_at }}
          ğŸ”„ ì‹¤í–‰ ë²ˆí˜¸: ${{ github.run_number }}
          
          ğŸ“ˆ í¬í•¨ëœ ë‚´ìš©:
          - ì›Œë“œ ë³´ê³ ì„œ (sales_analysis_report.docx)
          - ì‹œê°í™” ì°¨íŠ¸ (PNG íŒŒì¼ë“¤)
          
          ğŸ“‹ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ í™•ì¸í•˜ì„¸ìš”.
        files: |
          *.docx
          *.png
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Report generation summary
      if: always()
      run: |
        echo "ğŸ“Š ë³´ê³ ì„œ ìƒì„± ìš”ì•½:"
        echo "âœ… ì›Œë“œ ë³´ê³ ì„œ ë° ì°¨íŠ¸ ìƒì„± ì™„ë£Œ"
        echo "ğŸ“¦ Artifactë¡œ ì—…ë¡œë“œë¨ (30ì¼ ë³´ê´€)"
        if [ -f "*.docx" ]; then
          echo "ğŸ“„ ë³´ê³ ì„œ íŒŒì¼ í™•ì¸ë¨"
        fi
        if [ -f "*.png" ]; then
          echo "ğŸ“ˆ ì°¨íŠ¸ íŒŒì¼ í™•ì¸ë¨"
        fi
    
    - name: Send notification on failure
      if: failure()
      run: |
        echo "âŒ ë³´ê³ ì„œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
        
    - name: Clean up temporary files
      if: always()
      run: |
        echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
        # ì°¨íŠ¸ íŒŒì¼ë“¤ì€ artifactë¡œ ì—…ë¡œë“œë˜ë¯€ë¡œ ì •ë¦¬í•˜ì§€ ì•ŠìŒ
        echo "ì •ë¦¬ ì™„ë£Œ"