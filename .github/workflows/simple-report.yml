name: Simple Weekly Report

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (UTC+9) = ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤í›„ 11ì‹œ (UTC)
    - cron: '0 0 * * MON'  
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      email_notification:
        description: 'ì´ë©”ì¼ ì•Œë¦¼ ì‚¬ìš© ì—¬ë¶€'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  TZ: Asia/Seoul

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt || pip install pandas matplotlib seaborn numpy openpyxl python-docx
    
    - name: Generate report
      env:
        MPLBACKEND: Agg  # matplotlib headless ë°±ì—”ë“œ ì„¤ì •
      run: |
        echo "ğŸš€ ë³´ê³ ì„œ ìƒì„± ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        python github_actions_report.py
        echo "âœ… ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ"
    
    - name: Archive reports
      uses: actions/upload-artifact@v4
      with:
        name: sales-report-$(date +%Y%m%d)
        path: |
          sales_analysis_report.docx
          chart_*.png
        retention-days: 30

    - name: Commit and push if files changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ìƒì„±ëœ íŒŒì¼ë“¤ì„ reports ë””ë ‰í† ë¦¬ë¡œ ì´ë™
        mkdir -p reports/$(date +%Y%m%d)
        mv *.docx reports/$(date +%Y%m%d)/ 2>/dev/null || true
        mv chart_*.png reports/$(date +%Y%m%d)/ 2>/dev/null || true
        
        # README ì—…ë°ì´íŠ¸
        echo "# ğŸ“Š ì£¼ê°„ íŒë§¤ ë³´ê³ ì„œ ìë™ ìƒì„±" > reports/README.md
        echo "" >> reports/README.md
        echo "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> reports/README.md
        echo "" >> reports/README.md
        echo "## ğŸ“ ë³´ê³ ì„œ ëª©ë¡" >> reports/README.md
        ls -la reports/*/ >> reports/README.md 2>/dev/null || true
        
        git add reports/
        git diff --staged --quiet || git commit -m "ğŸ“Š ìë™ ìƒì„±ëœ ì£¼ê°„ ë³´ê³ ì„œ - $(date +%Y%m%d)"
        git push