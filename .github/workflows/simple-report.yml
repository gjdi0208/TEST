name: Simple Weekly Report

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (UTC+9) = ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤í›„ 11ì‹œ (UTC)
    - cron: '0 0 * * MON'  
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      email_notification:
        description: 'ì´ë©”ì¼ ì•Œë¦¼ ì‚¬ìš© ì—¬ë¶€'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  TZ: Asia/Seoul

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt || pip install pandas matplotlib seaborn numpy openpyxl python-docx
    
    - name: Configure for GitHub Actions
      run: |
        # ìŠ¤í¬ë¦½íŠ¸ë¥¼ GitHub Actions í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •
        python -c "
        import os
        
        # word_report_generator.py ìˆ˜ì •
        with open('word_report_generator.py', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # í•œê¸€ í°íŠ¸ë¥¼ DejaVu Sansë¡œ ë³€ê²½
        content = content.replace(\"plt.rcParams['font.family'] = 'Malgun Gothic'\", \"plt.rcParams['font.family'] = 'DejaVu Sans'\")
        
        # ëŒ€í™”í˜• ì´ë©”ì¼ ì „ì†¡ ë¹„í™œì„±í™”
        content = content.replace('send_email_interactive()', 'print(\"ğŸ“§ GitHub Actionsì—ì„œëŠ” ì´ë©”ì¼ ì „ì†¡ì„ ê±´ë„ˆëœë‹ˆë‹¤.\")')
        
        with open('word_report_generator.py', 'w', encoding='utf-8') as f:
            f.write(content)
        
        print('âœ… ìŠ¤í¬ë¦½íŠ¸ê°€ GitHub Actions í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.')
        "
    
    - name: Generate report
      run: |
        echo "ğŸš€ ë³´ê³ ì„œ ìƒì„± ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        python word_report_generator.py
        echo "âœ… ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ"
    
    - name: Archive reports
      uses: actions/upload-artifact@v4
      with:
        name: sales-report-$(date +%Y%m%d)
        path: |
          sales_analysis_report.docx
          chart_*.png
        retention-days: 30

    - name: Commit and push if files changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ìƒì„±ëœ íŒŒì¼ë“¤ì„ reports ë””ë ‰í† ë¦¬ë¡œ ì´ë™
        mkdir -p reports/$(date +%Y%m%d)
        mv *.docx reports/$(date +%Y%m%d)/ 2>/dev/null || true
        mv chart_*.png reports/$(date +%Y%m%d)/ 2>/dev/null || true
        
        # README ì—…ë°ì´íŠ¸
        echo "# ğŸ“Š ì£¼ê°„ íŒë§¤ ë³´ê³ ì„œ ìë™ ìƒì„±" > reports/README.md
        echo "" >> reports/README.md
        echo "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> reports/README.md
        echo "" >> reports/README.md
        echo "## ğŸ“ ë³´ê³ ì„œ ëª©ë¡" >> reports/README.md
        ls -la reports/*/ >> reports/README.md 2>/dev/null || true
        
        git add reports/
        git diff --staged --quiet || git commit -m "ğŸ“Š ìë™ ìƒì„±ëœ ì£¼ê°„ ë³´ê³ ì„œ - $(date +%Y%m%d)"
        git push